<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعادة كلمة المرور - سوق السيارات</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        .forgot-bg {
            background: linear-gradient(135deg, 
                rgba(245, 158, 11, 0.9) 0%, 
                rgba(217, 119, 6, 0.9) 100%),
                url('../assets/auth-bg/car-forgot.jpg');
            background-size: cover;
            background-position: center;
        }
        
        .instruction-box {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .recovery-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .recovery-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .recovery-option:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .recovery-option.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .recovery-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 1rem;
            flex-shrink: 0;
        }
        
        .recovery-phone .recovery-icon {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .recovery-email .recovery-icon {
            background: #dcfce7;
            color: #166534;
        }
        
        .timer-display {
            font-family: monospace;
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .resend-link {
            color: #3b82f6;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .resend-link:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
        
        .resend-link.disabled {
            color: #9ca3af;
            cursor: not-allowed;
            text-decoration: none;
        }
        
        .security-tip {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="forgot-bg min-h-screen flex items-center justify-center p-4">
    
    <!-- بطاقة استعادة كلمة المرور -->
    <div class="auth-card rounded-2xl w-full max-w-md animate__animated animate__fadeInUp">
        <!-- الشعار -->
        <div class="p-8 text-center">
            <div class="w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                <i class="fas fa-key text-white text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">استعادة كلمة المرور</h1>
            <p class="text-gray-600">اختر طريقة استعادة كلمة المرور المناسبة لك</p>
        </div>
        
        <!-- نموذج استعادة كلمة المرور -->
        <form id="forgotPasswordForm" class="p-8">
            <!-- تعليمات -->
            <div class="instruction-box">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-yellow-500 text-xl ml-3 mt-1"></i>
                    <div>
                        <p class="text-yellow-800 font-medium">تعليمات مهمة</p>
                        <p class="text-yellow-700 text-sm mt-1">
                            سوف نرسل لك رمز استعادة لتغيير كلمة المرور. 
                            تأكد من الوصول إلى طريقة الاستعادة المختارة.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- خيارات الاستعادة -->
            <div class="recovery-options">
                <div class="recovery-option recovery-phone" data-type="phone">
                    <div class="recovery-icon">
                        <i class="fas fa-mobile-alt text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">الهاتف المحمول</div>
                        <div class="text-gray-600 text-sm">إرسال رمز التحقق عبر الرسائل النصية</div>
                    </div>
                    <i class="fas fa-check-circle text-green-500 text-xl mr-auto hidden"></i>
                </div>
                
                <div class="recovery-option recovery-email" data-type="email">
                    <div class="recovery-icon">
                        <i class="fas fa-envelope text-xl"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">البريد الإلكتروني</div>
                        <div class="text-gray-600 text-sm">إرسال رابط استعادة عبر البريد الإلكتروني</div>
                    </div>
                    <i class="fas fa-check-circle text-green-500 text-xl mr-auto hidden"></i>
                </div>
            </div>
            
            <!-- نموذج إدخال الهاتف -->
            <div class="recovery-form hidden" id="phoneForm">
                <div class="input-group mb-6">
                    <input type="tel" 
                           id="recoveryPhone"
                           placeholder="رقم الهاتف المسجل"
                           class="form-input">
                    <i class="input-icon fas fa-phone"></i>
                    <div class="text-red-500 text-sm mt-1 hidden" id="phoneError"></div>
                </div>
                
                <button type="button" 
                        id="sendPhoneCode"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-xl font-bold hover:shadow-xl transition mb-4">
                    <i class="fas fa-paper-plane ml-2"></i> إرسال رمز التحقق
                </button>
            </div>
            
            <!-- نموذج إدخال البريد الإلكتروني -->
            <div class="recovery-form hidden" id="emailForm">
                <div class="input-group mb-6">
                    <input type="email" 
                           id="recoveryEmail"
                           placeholder="البريد الإلكتروني المسجل"
                           class="form-input">
                    <i class="input-icon fas fa-envelope"></i>
                    <div class="text-red-500 text-sm mt-1 hidden" id="emailError"></div>
                </div>
                
                <button type="button" 
                        id="sendEmailLink"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-xl font-bold hover:shadow-xl transition mb-4">
                    <i class="fas fa-paper-plane ml-2"></i> إرسال رابط الاستعادة
                </button>
            </div>
            
            <!-- إدخال رمز التحقق -->
            <div class="verification-section hidden" id="verificationSection">
                <div class="text-center mb-6">
                    <p class="text-gray-600 mb-2">أدخل رمز التحقق المكون من 6 أرقام</p>
                    <div class="verification-inputs mb-4">
                        <input type="text" maxlength="1" class="verification-input">
                        <input type="text" maxlength="1" class="verification-input">
                        <input type="text" maxlength="1" class="verification-input">
                        <input type="text" maxlength="1" class="verification-input">
                        <input type="text" maxlength="1" class="verification-input">
                        <input type="text" maxlength="1" class="verification-input">
                    </div>
                    
                    <div class="text-center mb-4">
                        <p class="text-gray-600 mb-2">الوقت المتبقي:</p>
                        <div class="timer-display">05:00</div>
                    </div>
                    
                    <p class="text-gray-600">
                        لم يصلك الرمز؟ 
                        <span id="resendCode" class="resend-link">إعادة إرسال</span>
                    </p>
                </div>
                
                <button type="button" 
                        id="verifyCode"
                        class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4 rounded-xl font-bold hover:shadow-xl transition mb-4">
                    <i class="fas fa-check ml-2"></i> التحقق من الرمز
                </button>
            </div>
            
            <!-- تلميح أمان -->
            <div class="security-tip">
                <div class="flex items-start">
                    <i class="fas fa-shield-alt text-yellow-500 ml-3 mt-1"></i>
                    <div>
                        <p class="text-yellow-800 font-medium">نصائح أمان</p>
                        <ul class="text-yellow-700 text-sm mt-1 list-disc pr-5">
                            <li>لا تشارك رمز التحقق مع أحد</li>
                            <li>تأكد من أنك تطلب الاستعادة من جهازك الموثوق</li>
                            <li>إذا لم تطلب الاستعادة، قم بتغيير كلمة المرور فوراً</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- روابط إضافية -->
            <div class="text-center pt-6 border-t mt-6">
                <p class="text-gray-600">
                    تذكرت كلمة المرور؟ 
                    <a href="login.html" class="text-blue-600 hover:text-blue-800 font-medium transition">
                        سجّل الدخول
                    </a>
                </p>
            </div>
        </form>
        
        <!-- تذييل البطاقة -->
        <div class="p-6 border-t bg-gray-50 rounded-b-2xl">
            <div class="text-center text-gray-500 text-sm">
                <i class="fas fa-headset ml-2"></i>
                للدعم الفني: 
                <a href="tel:+966112345678" class="text-blue-600 hover:text-blue-800">9200 12345</a>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="../js/auth-validation.js"></script>
    <script src="../js/auth-utils.js"></script>
    <script src="../js/auth-main.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // المتغيرات
            let selectedRecoveryType = null;
            let countdownTimer;
            let countdownSeconds = 300; // 5 دقائق
            let recoveryToken = null;
            
            // العناصر
            const recoveryOptions = document.querySelectorAll('.recovery-option');
            const phoneForm = document.getElementById('phoneForm');
            const emailForm = document.getElementById('emailForm');
            const verificationSection = document.getElementById('verificationSection');
            const verificationInputs = document.querySelectorAll('.verification-input');
            const timerDisplay = document.querySelector('.timer-display');
            const resendCodeLink = document.getElementById('resendCode');
            
            // تهيئة التحقق
            const validator = new AuthValidator();
            
            // اختيار طريقة الاستعادة
            recoveryOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // إلغاء تحديد الخيارات الأخرى
                    recoveryOptions.forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.fa-check-circle').classList.add('hidden');
                    });
                    
                    // تحديد الخيار الحالي
                    this.classList.add('selected');
                    this.querySelector('.fa-check-circle').classList.remove('hidden');
                    
                    selectedRecoveryType = this.dataset.type;
                    
                    // عرض النموذج المناسب
                    if (selectedRecoveryType === 'phone') {
                        phoneForm.classList.remove('hidden');
                        emailForm.classList.add('hidden');
                        verificationSection.classList.add('hidden');
                    } else {
                        phoneForm.classList.add('hidden');
                        emailForm.classList.remove('hidden');
                        verificationSection.classList.add('hidden');
                    }
                });
            });
            
            // إرسال رمز التحقق للهاتف
            document.getElementById('sendPhoneCode').addEventListener('click', function() {
                const phone = document.getElementById('recoveryPhone').value;
                
                if (!phone) {
                    showErrorMessage('الرجاء إدخال رقم الهاتف');
                    return;
                }
                
                if (!AuthUtils.validatePhone(phone)) {
                    showErrorMessage('رقم الهاتف غير صالح');
                    return;
                }
                
                // إرسال رمز التحقق
                AuthAPI.sendPasswordResetCode(phone, 'phone')
                    .then(response => {
                        showSuccessMessage('تم إرسال رمز التحقق إلى هاتفك');
                        recoveryToken = response.token;
                        
                        // عرض قسم التحقق
                        phoneForm.classList.add('hidden');
                        verificationSection.classList.remove('hidden');
                        
                        // بدء العد التنازلي
                        startCountdown();
                    })
                    .catch(error => {
                        showErrorMessage('فشل إرسال رمز التحقق: ' + error.message);
                    });
            });
            
            // إرسال رابط الاستعادة للبريد الإلكتروني
            document.getElementById('sendEmailLink').addEventListener('click', function() {
                const email = document.getElementById('recoveryEmail').value;
                
                if (!email) {
                    showErrorMessage('الرجاء إدخال البريد الإلكتروني');
                    return;
                }
                
                if (!AuthUtils.validateEmail(email)) {
                    showErrorMessage('البريد الإلكتروني غير صالح');
                    return;
                }
                
                // إرسال رابط الاستعادة
                AuthAPI.sendPasswordResetLink(email)
                    .then(response => {
                        showSuccessMessage('تم إرسال رابط الاستعادة إلى بريدك الإلكتروني');
                        
                        // إظهار رسالة إرشادية
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mt-4';
                        messageDiv.innerHTML = `
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 text-xl ml-3 mt-1"></i>
                                <div>
                                    <p class="text-green-800 font-bold">تم الإرسال بنجاح!</p>
                                    <p class="text-green-700 text-sm mt-1">
                                        تحقق من صندوق بريدك الإلكتروني واتبع التعليمات في الرسالة.
                                        قد يستغرق وصول الرسالة بضع دقائق.
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        emailForm.parentNode.insertBefore(messageDiv, emailForm.nextSibling);
                        
                        // إعادة تعيين الزر
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-check ml-2"></i> تم الإرسال';
                    })
                    .catch(error => {
                        showErrorMessage('فشل إرسال رابط الاستعادة: ' + error.message);
                    });
            });
            
            // التحقق من الرمز
            document.getElementById('verifyCode').addEventListener('click', function() {
                const code = Array.from(verificationInputs)
                    .map(input => input.value)
                    .join('');
                
                if (code.length !== 6) {
                    showErrorMessage('الرجاء إدخال رمز التحقق المكون من 6 أرقام');
                    return;
                }
                
                AuthAPI.verifyResetCode(recoveryToken, code)
                    .then(response => {
                        showSuccessMessage('تم التحقق بنجاح!');
                        
                        // إعادة التوجيه لصفحة إعادة تعيين كلمة المرور
                        setTimeout(() => {
                            window.location.href = `reset-password.html?token=${response.resetToken}`;
                        }, 1500);
                    })
                    .catch(error => {
                        showErrorMessage('رمز التحقق غير صحيح أو منتهي الصلاحية');
                    });
            });
            
            // إعادة إرسال الرمز
            resendCodeLink.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;
                
                // إعادة إرسال الرمز
                AuthAPI.resendResetCode(recoveryToken)
                    .then(response => {
                        showSuccessMessage('تم إعادة إرسال رمز التحقق');
                        
                        // إعادة تعيين العد التنازلي
                        resetCountdown();
                    })
                    .catch(error => {
                        showErrorMessage('فشل إعادة إرسال الرمز');
                    });
            });
            
            // التعامل مع إدخال رمز التحقق
            verificationInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    // التحرك للخانة التالية تلقائياً
                    if (this.value.length === 1 && index < verificationInputs.length - 1) {
                        verificationInputs[index + 1].focus();
                    }
                    
                    // تحديث نمط الخانة
                    this.classList.toggle('filled', this.value.length === 1);
                    
                    // التحقق التلقائي عند اكتمال الرمز
                    const code = Array.from(verificationInputs)
                        .map(input => input.value)
                        .join('');
                    
                    if (code.length === 6) {
                        document.getElementById('verifyCode').click();
                    }
                });
                
                // التعامل مع مفتاح Backspace
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        verificationInputs[index - 1].focus();
                    }
                });
            });
            
            // دوال المساعدة
            function startCountdown() {
                clearInterval(countdownTimer);
                countdownSeconds = 300; // 5 دقائق
                updateTimerDisplay();
                
                countdownTimer = setInterval(() => {
                    countdownSeconds--;
                    updateTimerDisplay();
                    
                    if (countdownSeconds <= 0) {
                        clearInterval(countdownTimer);
                        resendCodeLink.classList.remove('disabled');
                        resendCodeLink.textContent = 'إعادة إرسال الرمز';
                    }
                }, 1000);
            }
            
            function resetCountdown() {
                startCountdown();
                resendCodeLink.classList.add('disabled');
                resendCodeLink.textContent = 'إعادة إرسال';
            }
            
            function updateTimerDisplay() {
                const minutes = Math.floor(countdownSeconds / 60);
                const seconds = countdownSeconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // تغيير اللون عند اقتراب انتهاء الوقت
                if (countdownSeconds < 60) {
                    timerDisplay.style.color = '#ef4444'; // أحمر
                } else if (countdownSeconds < 120) {
                    timerDisplay.style.color = '#f59e0b'; // أصفر
                } else {
                    timerDisplay.style.color = '#3b82f6'; // أزرق
                }
            }
            
            function showSuccessMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 z-50 px-6 py-3 bg-green-500 text-white rounded-lg shadow-lg animate__animated animate__fadeInDown';
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-3"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.classList.add('animate__fadeOutUp');
                    setTimeout(() => messageDiv.remove(), 300);
                }, 3000);
            }
            
            function showErrorMessage(message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 z-50 px-6 py-3 bg-red-500 text-white rounded-lg shadow-lg animate__animated animate__fadeInDown';
                messageDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-3"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.classList.add('animate__fadeOutUp');
                    setTimeout(() => messageDiv.remove(), 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>